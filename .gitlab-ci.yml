image: docker:latest
services:
  - docker:dind

variables:
  REGISTRY_PATH: docker.io/vshn
  DOCKER_HUB_PATH: docker.io/vshn
  KUBECONFIG: /tmp/kube
  OC_VERSION: v3.9
  OPENSHIFT_PROJECT: vshn-signalilo-prod
  OPENSHIFT_TOKEN: $KUBE_TOKEN
  OPENSHIFT_URL: $KUBE_URL

.dockerbuild: &dockerbuild
  before_script:
    - docker info
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  script:
    - docker pull ${CI_REGISTRY}/${CI_PROJECT_PATH}:builder || true
    - docker build --target builder --cache-from ${CI_REGISTRY}/${CI_PROJECT_PATH}:builder --tag ${CI_REGISTRY}/${CI_PROJECT_PATH}:builder .
    - docker build --cache-from ${CI_REGISTRY}/${CI_PROJECT_PATH}:builder --tag ${CI_REGISTRY}/${CI_PROJECT_PATH}:${IMAGE_TAG} .
    - docker push ${CI_REGISTRY}/${CI_PROJECT_PATH}:builder
    - docker push ${CI_REGISTRY}/${CI_PROJECT_PATH}:${IMAGE_TAG}
  tags:
    - dockerbuild

.dockerhubpush: &dockerhubpush
  before_script:
    - docker info
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
    - echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USER --password-stdin
  script:
    - docker pull ${CI_REGISTRY}/${CI_PROJECT_PATH}:${IMAGE_TAG}
    - docker tag ${CI_REGISTRY}/${CI_PROJECT_PATH}:${IMAGE_TAG} ${REGISTRY_PATH}/signalilo:${IMAGE_TAG}
    - docker push ${REGISTRY_PATH}/signalilo:${IMAGE_TAG}
    # Also tag image we're pushing to dockerhub as latest
    - docker tag ${CI_REGISTRY}/${CI_PROJECT_PATH}:${IMAGE_TAG} ${REGISTRY_PATH}/signalilo:latest
    - docker push ${REGISTRY_PATH}/signalilo:latest
  tags:
    - dockerbuild

build:dev:
  stage: build
  variables:
    IMAGE_TAG: dev
  <<: *dockerbuild
  tags:
    - dockerbuild
  only:
    - dev

build:mr:
  stage: build
  variables:
    IMAGE_TAG: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
  <<: *dockerbuild
  only:
    - merge_requests

build:latest:
  stage: build
  variables:
    IMAGE_TAG: latest
  <<: *dockerbuild
  only:
    - master

build:tag:
  stage: build
  variables:
    IMAGE_TAG: ${CI_COMMIT_TAG}
  <<: *dockerbuild
  only:
    - tags

push:tag:
  stage: deploy
  variables:
    IMAGE_TAG: ${CI_COMMIT_TAG}
  <<: *dockerhubpush
  only:
    - tags
